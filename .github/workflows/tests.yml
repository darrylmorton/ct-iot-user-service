name: Tests

on:
  push:
    branches-ignore: ["main"]

env:
  SERVICE_NAME: user-service-test
  LOG_LEVEL: DEBUG
  ENVIRONMENT: TEST
  APP_PORT: 8001
  DB_USERNAME: postgres
  DB_PASSWORD: postgres
  DB_HOST: localhost
  DB_PORT: 5432
  DB_NAME: users

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up python:wq
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Load cached Poetry installation
        id: cached-poetry
        uses: actions/cache@v3
        with:
          path: ~/.local  # the path depends on the OS
          key: poetry-0  # increment to reset cache

#      - name: Venv
#        run: python3 -m venv ./venv
#
#      - name: Activate venv
#        run: . ./venv/bin/activate

      - name: Install Poetry
        if: steps.cached-poetry.outputs.cache-hit != 'true'
        uses: snok/install-poetry@v1

      - name: Install project
        run: poetry install --no-interaction --no-root

      - name: Run unit tests
        run: make test-unit

      - name: Setup dependencies
        run: docker-compose up -d

#      - name: Sleep
#        uses: kibertoad/wait-action@1.0.1
#        with:
#          time: '30s'

      - name: Check Alembic Migration Version
        uses: DevGlitch/alembic-migration-checker@v1
        with:
          db_host: ${{ env.DB_HOST }}
#          db_port: ${{ env.DB_PORT }}  # Only if not using 5432 default port
          db_user: ${{ env.DB_USERNAME }}
          db_password: ${{ env.DB_PASSWORD }}
          db_name: ${{ env.DB_NAME }}
          migrations_path: ./alembic/

#      - name: Run migrations
#        run: make run-migrations

      - name: Run tests
        run: make test-integration
